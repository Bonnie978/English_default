import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import styled from 'styled-components';
import { useLearning } from '../hooks/useLearning';
import HeaderBar from '../components/common/HeaderBar';
import ProgressBar from '../components/common/ProgressBar';
import WordCard from '../components/wordlist/WordCard';
import NavigationButtons from '../components/wordlist/NavigationButtons';
import BottomNavbar from '../components/common/BottomNavbar';
import Loading from '../components/common/Loading';

const WordlistPage: React.FC = () => {
  const { 
    dailyWords, 
    loading, 
    error, 
    progress, 
    fetchDailyWords, 
    markWordAsMastered,
    recordLearningSession,
    masteredWordIds
  } = useLearning();
  
  const [currentWordIndex, setCurrentWordIndex] = useState(0);
  const [isCompleting, setIsCompleting] = useState(false);
  const navigate = useNavigate();
  
  // è·å–æ¯æ—¥å•è¯
  useEffect(() => {
    if ((dailyWords?.length || 0) === 0) {
      fetchDailyWords();
    }
  }, [fetchDailyWords, dailyWords?.length]);
  
  // å¤„ç†ä¸Šä¸€ä¸ªå•è¯
  const handlePrevWord = () => {
    if (currentWordIndex > 0) {
      setCurrentWordIndex(currentWordIndex - 1);
    }
  };
  
  // å¤„ç†ä¸‹ä¸€ä¸ªå•è¯
  const handleNextWord = () => {
    if (currentWordIndex < (dailyWords?.length || 0) - 1) {
      setCurrentWordIndex(currentWordIndex + 1);
    }
  };
  
  // åˆ‡æ¢å•è¯æŒæ¡çŠ¶æ€
  const handleToggleMastered = async () => {
    if ((dailyWords?.length || 0) > 0) {
      const currentWord = dailyWords[currentWordIndex];
      await markWordAsMastered(currentWord.id);
    }
  };
  
  // æ’­æ”¾å‘éŸ³ï¼ˆå®é™…åº”ç”¨ä¸­åº”è¿æ¥åˆ°çœŸå®çš„éŸ³é¢‘æœåŠ¡ï¼‰
  const handlePlayPronunciation = () => {
    console.log('Playing pronunciation...');
    // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨éŸ³é¢‘APIæˆ–ä½¿ç”¨HTML5 Audio
    alert('æ’­æ”¾å‘éŸ³åŠŸèƒ½å°†åœ¨åç»­ç‰ˆæœ¬ä¸­å®ç°');
  };
  
  // å®Œæˆå­¦ä¹ ä¼šè¯å¹¶è®°å½•è¿›åº¦
  const handleComplete = async () => {
    try {
      setIsCompleting(true);
      
      // æ„å»ºå­¦ä¹ ä¼šè¯æ•°æ®ï¼šæ‰€æœ‰çœ‹è¿‡çš„å•è¯éƒ½è®°ä¸º"æ­£ç¡®"ï¼ˆå› ä¸ºå·²ç»å®Œæˆå­¦ä¹ ï¼‰
      // å·²æŒæ¡çš„å•è¯æ ‡è®°ä¸ºæ­£ç¡®ï¼ŒæœªæŒæ¡çš„æ ‡è®°ä¸ºéœ€è¦å¤ä¹ 
      const learningSession = dailyWords.map(word => ({
        wordId: word.id,
        isCorrect: masteredWordIds.includes(word.id), // åŸºäºç”¨æˆ·æ˜¯å¦æ ‡è®°ä¸ºå·²æŒæ¡
        timeSpent: 60 // ä¼°ç®—æ¯ä¸ªå•è¯60ç§’å­¦ä¹ æ—¶é—´
      }));
      
      // è®°å½•å­¦ä¹ ä¼šè¯
      await recordLearningSession(learningSession);
      
      // æ˜¾ç¤ºå®Œæˆæç¤º
      alert(`ğŸ‰ ä»Šæ—¥å­¦ä¹ å®Œæˆï¼\nå·²å­¦ä¹  ${dailyWords.length} ä¸ªå•è¯\næŒæ¡ ${masteredWordIds.length} ä¸ªå•è¯`);
      
      // è·³è½¬åˆ°ç»ƒä¹ é¡µé¢
      navigate('/exam');
    } catch (error) {
      console.error('å®Œæˆå­¦ä¹ å¤±è´¥:', error);
      alert('è®°å½•å­¦ä¹ è¿›åº¦å¤±è´¥ï¼Œè¯·é‡è¯•');
    } finally {
      setIsCompleting(false);
    }
  };
  
  // æ¸²æŸ“å³ä¾§å†…å®¹
  const renderRightContent = () => (
    <MasteredCount>
      å·²æŒæ¡: {progress?.learned || 0}/{progress?.total || 0}
    </MasteredCount>
  );
  
  // åŠ è½½çŠ¶æ€
  if (loading && (dailyWords?.length || 0) === 0) {
    return (
      <Container>
        <HeaderBar title="ä»Šæ—¥å•è¯" showBack rightContent={renderRightContent()} />
        <LoadingContainer>
          <Loading size="large" />
        </LoadingContainer>
      </Container>
    );
  }
  
  // é”™è¯¯çŠ¶æ€
  if (error && (dailyWords?.length || 0) === 0) {
    return (
      <Container>
        <HeaderBar title="ä»Šæ—¥å•è¯" showBack />
        <ErrorContainer>
          <ErrorMessage>{error}</ErrorMessage>
          <RetryButton onClick={fetchDailyWords}>é‡è¯•</RetryButton>
        </ErrorContainer>
      </Container>
    );
  }
  
  // æ²¡æœ‰æ•°æ®
  if (!loading && (dailyWords?.length || 0) === 0) {
    return (
      <Container>
        <HeaderBar title="ä»Šæ—¥å•è¯" showBack />
        <EmptyContainer>
          <EmptyMessage>ä»Šæ—¥æ²¡æœ‰éœ€è¦å­¦ä¹ çš„å•è¯</EmptyMessage>
          <HomeButton onClick={() => navigate('/')}>è¿”å›é¦–é¡µ</HomeButton>
        </EmptyContainer>
        <BottomNavbar />
      </Container>
    );
  }
  
  // æœ‰å•è¯æ•°æ®ï¼Œæ˜¾ç¤ºå­¦ä¹ ç•Œé¢
  const currentWord = dailyWords?.[currentWordIndex];
  const isCurrentWordMastered = masteredWordIds?.includes(currentWord?.id);
  
  return (
    <Container>
      <HeaderBar 
        title="ä»Šæ—¥å•è¯" 
        showBack 
        rightContent={renderRightContent()} 
      />
      
      <MainContent>
        <ProgressBar 
          current={currentWordIndex + 1} 
          total={dailyWords?.length || 0} 
          label="å­¦ä¹ è¿›åº¦" 
        />
        
        <WordCard 
          word={currentWord}
          isMastered={isCurrentWordMastered}
          onToggleMastered={handleToggleMastered}
          onPlayPronunciation={handlePlayPronunciation}
        />
        
        <NavigationButtons 
          onPrevious={handlePrevWord}
          onNext={handleNextWord}
          isPreviousDisabled={currentWordIndex === 0}
          isNextDisabled={currentWordIndex === (dailyWords?.length || 0) - 1}
        />
        
        <CompleteButtonContainer>
          <CompleteButton 
            onClick={handleComplete}
            disabled={isCompleting || loading}
          >
            {isCompleting ? 'è®°å½•å­¦ä¹ è¿›åº¦ä¸­...' : 'å®ŒæˆèƒŒè¯µ'}
          </CompleteButton>
        </CompleteButtonContainer>
      </MainContent>
      
      <BottomNavbar />
    </Container>
  );
};

// æ ·å¼ç»„ä»¶
const Container = styled.div`
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  background-color: #f9fafb;
`;

const MainContent = styled.main`
  flex: 1;
  max-width: 1280px;
  margin: 0 auto;
  padding: 1.5rem 1rem;
  width: 100%;
`;

const LoadingContainer = styled.div`
  flex: 1;
  display: flex;
  justify-content: center;
  align-items: center;
`;

const ErrorContainer = styled.div`
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  padding: 2rem;
`;

const ErrorMessage = styled.p`
  color: #ef4444;
  text-align: center;
  margin-bottom: 1rem;
`;

const RetryButton = styled.button`
  background-color: #3b82f6;
  color: white;
  font-weight: 500;
  padding: 0.5rem 1.5rem;
  border-radius: 0.375rem;
  border: none;
  cursor: pointer;
  
  &:hover {
    background-color: #2563eb;
  }
`;

const EmptyContainer = styled.div`
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  padding: 2rem;
`;

const EmptyMessage = styled.p`
  color: #6b7280;
  text-align: center;
  margin-bottom: 1rem;
`;

const HomeButton = styled.button`
  background-color: #3b82f6;
  color: white;
  font-weight: 500;
  padding: 0.5rem 1.5rem;
  border-radius: 0.375rem;
  border: none;
  cursor: pointer;
  
  &:hover {
    background-color: #2563eb;
  }
`;

const MasteredCount = styled.span`
  font-size: 0.875rem;
  color: #6b7280;
`;

const CompleteButtonContainer = styled.div`
  display: flex;
  justify-content: center;
`;

const CompleteButton = styled.button`
  background-color: #3b82f6;
  color: white;
  font-weight: 500;
  padding: 0.75rem 1.5rem;
  border-radius: 0.375rem;
  border: none;
  cursor: pointer;
  box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
  
  &:hover:not(:disabled) {
    background-color: #2563eb;
  }
  
  &:disabled {
    background-color: #9ca3af;
    cursor: not-allowed;
    opacity: 0.7;
  }
`;

export default WordlistPage; 