
### 1. åˆ›å»ºè®¤è¯ä¸­é—´ä»¶

```typescript
// src/middleware/auth.middleware.ts
import { Request, Response, NextFunction } from 'express';
import jwt from 'jsonwebtoken';
import { config } from '../config/env';
import { User } from '../models/User';

// æ‰©å±• Express çš„ Request æ¥å£ä»¥åŒ…å«ç”¨æˆ·ä¿¡æ¯
declare global {
  namespace Express {
    interface Request {
      user?: any;
    }
  }
}

export const authenticate = async (req: Request, res: Response, next: NextFunction) => {
  try {
    // è·å–æˆæƒå¤´
    const authHeader = req.headers.authorization;
    
    // æ£€æŸ¥æ˜¯å¦æœ‰æˆæƒå¤´
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      return res.status(401).json({
        success: false,
        message: 'æœªæˆæƒè®¿é—®ï¼Œè¯·ç™»å½•'
      });
    }
    
    // æå–ä»¤ç‰Œ
    const token = authHeader.split(' ')[1];
    
    // éªŒè¯ä»¤ç‰Œ
    const decoded = jwt.verify(token, config.JWT_SECRET) as { userId: string };
    
    // æŸ¥è¯¢ç”¨æˆ·
    const user = await User.findById(decoded.userId).select('-passwordHash');
    
    if (!user) {
      return res.status(401).json({
        success: false,
        message: 'ç”¨æˆ·ä¸å­˜åœ¨æˆ–ä»¤ç‰Œæ— æ•ˆ'
      });
    }
    
    // å°†ç”¨æˆ·ä¿¡æ¯æ·»åŠ åˆ°è¯·æ±‚ä¸­
    req.user = user;
    next();
  } catch (error) {
    return res.status(401).json({
      success: false,
      message: 'ä»¤ç‰Œæ— æ•ˆæˆ–å·²è¿‡æœŸ'
    });
  }
};
```

### 2. åˆ›å»ºè®¤è¯æ§åˆ¶å™¨

```typescript
// src/controllers/auth.controller.ts
import { Request, Response } from 'express';
import jwt from 'jsonwebtoken';
import { User } from '../models/User';
import { config } from '../config/env';

// æ³¨å†Œæ–°ç”¨æˆ·
export const register = async (req: Request, res: Response) => {
  try {
    const { username, email, password } = req.body;
    
    // éªŒè¯è¾“å…¥
    if (!username || !email || !password) {
      return res.status(400).json({
        success: false,
        message: 'ç”¨æˆ·åã€é‚®ç®±å’Œå¯†ç ä¸ºå¿…å¡«é¡¹'
      });
    }
    
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨
    const existingUser = await User.findOne({ 
      $or: [{ email }, { username }] 
    });
    
    if (existingUser) {
      return res.status(400).json({
        success: false,
        message: 'ç”¨æˆ·åæˆ–é‚®ç®±å·²è¢«æ³¨å†Œ'
      });
    }
    
    // åˆ›å»ºæ–°ç”¨æˆ·
    const newUser = new User({
      username,
      email,
      passwordHash: password // ä¸­é—´ä»¶ä¼šè‡ªåŠ¨åŠ å¯†
    });
    
    await newUser.save();
    
    // ç”ŸæˆJWTä»¤ç‰Œ
    const token = jwt.sign(
      { userId: newUser._id },
      config.JWT_SECRET,
      { expiresIn: config.JWT_EXPIRES_IN }
    );
    
    res.status(201).json({
      success: true,
      message: 'æ³¨å†ŒæˆåŠŸ',
      userId: newUser._id,
      token
    });
  } catch (error) {
    console.error('æ³¨å†Œé”™è¯¯:', error);
    res.status(500).json({
      success: false,
      message: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åå†è¯•'
    });
  }
};

// ç”¨æˆ·ç™»å½•
export const login = async (req: Request, res: Response) => {
  try {
    const { email, password } = req.body;
    
    // éªŒè¯è¾“å…¥
    if (!email || !password) {
      return res.status(400).json({
        success: false,
        message: 'é‚®ç®±å’Œå¯†ç ä¸ºå¿…å¡«é¡¹'
      });
    }
    
    // æŸ¥æ‰¾ç”¨æˆ·
    const user = await User.findOne({ email });
    
    if (!user) {
      return res.status(401).json({
        success: false,
        message: 'é‚®ç®±æˆ–å¯†ç ä¸æ­£ç¡®'
      });
    }
    
    // éªŒè¯å¯†ç 
    const isPasswordValid = await user.comparePassword(password);
    
    if (!isPasswordValid) {
      return res.status(401).json({
        success: false,
        message: 'é‚®ç®±æˆ–å¯†ç ä¸æ­£ç¡®'
      });
    }
    
    // æ›´æ–°æœ€åç™»å½•æ—¶é—´
    user.lastLoginAt = new Date();
    await user.save();
    
    // ç”ŸæˆJWTä»¤ç‰Œ
    const token = jwt.sign(
      { userId: user._id },
      config.JWT_SECRET,
      { expiresIn: config.JWT_EXPIRES_IN }
    );
    
    res.status(200).json({
      success: true,
      message: 'ç™»å½•æˆåŠŸ',
      userId: user._id,
      username: user.username,
      token
    });
  } catch (error) {
    console.error('ç™»å½•é”™è¯¯:', error);
    res.status(500).json({
      success: false,
      message: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åå†è¯•'
    });
  }
};

// è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
export const getCurrentUser = async (req: Request, res: Response) => {
  try {
    const user = req.user;
    
    res.status(200).json({
      success: true,
      user: {
        _id: user._id,
        username: user.username,
        email: user.email,
        learningStats: user.learningStats,
        settings: user.settings,
        createdAt: user.createdAt
      }
    });
  } catch (error) {
    console.error('è·å–ç”¨æˆ·ä¿¡æ¯é”™è¯¯:', error);
    res.status(500).json({
      success: false,
      message: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åå†è¯•'
    });
  }
};
```

### 3. åˆ›å»ºè®¤è¯è·¯ç”±

```typescript
// src/routes/auth.routes.ts
import { Router } from 'express';
import { register, login, getCurrentUser } from '../controllers/auth.controller';
import { authenticate } from '../middleware/auth.middleware';

const router = Router();

// æ³¨å†Œè·¯ç”±
router.post('/register', register);

// ç™»å½•è·¯ç”±
router.post('/login', login);

// è·å–å½“å‰ç”¨æˆ·è·¯ç”±(éœ€è¦è®¤è¯)
router.get('/me', authenticate, getCurrentUser);

export default router;
```

### 4. æ›´æ–°åº”ç”¨å…¥å£æ–‡ä»¶ï¼Œæ·»åŠ è®¤è¯è·¯ç”±

```typescript
// src/index.ts æ›´æ–°
import express from 'express';
import cors from 'cors';
import { config } from './config/env';
import { connectMongoDB } from './config/database';
import { connectRedis } from './config/redis';
import authRoutes from './routes/auth.routes';

// åˆå§‹åŒ–Expressåº”ç”¨
const app = express();

// ä¸­é—´ä»¶
app.use(express.json());
app.use(express.urlencoded({ extended: true }));
app.use(cors({
  origin: config.CORS_ORIGIN,
  credentials: true
}));

// è¿æ¥æ•°æ®åº“
(async () => {
  await connectMongoDB();
  await connectRedis();
})();

// è·¯ç”±
app.get('/', (req, res) => {
  res.json({ message: 'Welcome to Vocabulary App API' });
});

// æ·»åŠ APIè·¯ç”±
app.use('/api/auth', authRoutes);

// å¯åŠ¨æœåŠ¡å™¨
app.listen(config.PORT, () => {
  console.log(`ğŸš€ Server running on port ${config.PORT} in ${config.NODE_ENV} mode`);
});
```

### éªŒè¯æ­¥éª¤

1. **å¯åŠ¨æœåŠ¡å™¨**:
```bash
npm run dev  # æˆ–è€…ä½ é…ç½®çš„å¯åŠ¨è„šæœ¬
```

2. **æµ‹è¯•æ³¨å†ŒåŠŸèƒ½**:
```bash
curl -X POST http://localhost:5001/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","email":"test@example.com","password":"password123"}'
```
é¢„æœŸç»“æœ: åº”è¯¥è¿”å›æˆåŠŸä¿¡æ¯ã€ç”¨æˆ·IDå’ŒJWTä»¤ç‰Œ

3. **æµ‹è¯•ç™»å½•åŠŸèƒ½**:
```bash
curl -X POST http://localhost:5001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"password123"}'
```
é¢„æœŸç»“æœ: åº”è¯¥è¿”å›æˆåŠŸä¿¡æ¯ã€ç”¨æˆ·IDã€ç”¨æˆ·åå’ŒJWTä»¤ç‰Œ

4. **æµ‹è¯•èº«ä»½éªŒè¯**:
```bash
curl -X GET http://localhost:5001/api/auth/me \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```
é¢„æœŸç»“æœ: åº”è¯¥è¿”å›å½“å‰ç”¨æˆ·ä¿¡æ¯

